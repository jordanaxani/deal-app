<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Collab Deal Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app" class="p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Shift Collab Deal Tracker</h1>
                        <p class="text-gray-600 mt-1">Simple pipeline management for executives</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            <span id="refreshIcon">ðŸ”„</span>
                            Refresh
                        </button>
                        <button id="addDealBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <span>âž•</span>
                            Add Deal
                        </button>
                    </div>
                </div>

                <!-- Configuration -->
                <div id="config" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <h3 class="font-medium text-yellow-800 mb-2">Connect to HubSpot</h3>
                    <p class="text-sm text-yellow-700 mb-3">Enter your details to connect to HubSpot (showing demo data for now)</p>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Backend URL</label>
                            <input type="url" id="backendUrl" placeholder="https://deals-app-rho.vercel.app" 
                                   value="https://deals-app-rho.vercel.app"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">HubSpot Access Token</label>
                            <div class="flex gap-2">
                                <input type="password" id="apiKey" placeholder="pat-xxx..." 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <button id="connectBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700">
                                    Connect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-green-600">ðŸ’°</span>
                            <span class="text-sm font-medium text-green-800">Total Pipeline Value</span>
                        </div>
                        <div id="totalValue" class="text-2xl font-bold text-green-900 mt-1">$91,500.00</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-blue-600">ðŸ‘¥</span>
                            <span class="text-sm font-medium text-blue-800">Active Deals</span>
                        </div>
                        <div id="activeCount" class="text-2xl font-bold text-blue-900 mt-1">3</div>
                    </div>
                </div>
            </div>

            <!-- Deals List -->
            <div id="dealsList" class="space-y-4">
                <!-- Deals will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Add Deal Modal -->
    <div id="addDealModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-lg font-semibold mb-4">Add New Deal</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deal Name *</label>
                    <input type="text" id="newDealName" class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="ABC Corp - Therapy Services">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deal Value (CAD) *</label>
                    <input type="number" id="newDealAmount" class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="25000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Close Date</label>
                    <input type="date" id="newDealDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="cancelDealBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button id="saveDealBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Add Deal
                </button>
            </div>
        </div>
    </div>

    <script>
        // App state
        let deals = [];
        let isConfigured = false;
        let loading = false;

        // Demo data
        const demoDeals = [
            {
                id: '1',
                dealname: 'ABC Corporation - Therapy Services',
                amount: 45000,
                dealstage: 'qualifiedtobuy',
                closedate: '2025-09-15',
                contact: 'Sarah Johnson',
                email: 'sarah@abccorp.com',
                phone: '+1 (555) 123-4567',
                companies: [{ name: 'ABC Corporation' }]
            },
            {
                id: '2',
                dealname: 'XYZ University - Student Support',
                amount: 28000,
                dealstage: 'presentationscheduled',
                closedate: '2025-09-28',
                contact: 'Dr. Michael Chen',
                email: 'mchen@xyzuni.edu',
                phone: '+1 (555) 987-6543',
                companies: [{ name: 'XYZ University' }]
            },
            {
                id: '3',
                dealname: 'TechStart Inc - Employee Wellness',
                amount: 18500,
                dealstage: 'appointmentscheduled',
                closedate: '2025-10-05',
                contact: 'Jennifer Lee',
                email: 'jen.lee@techstart.com',
                phone: '+1 (555) 456-7890',
                companies: [{ name: 'TechStart Inc' }]
            }
        ];

        const dealStages = [
            { id: 'appointmentscheduled', name: 'Appointment Scheduled', color: 'bg-blue-100 text-blue-800' },
            { id: 'qualifiedtobuy', name: 'Qualified to Buy', color: 'bg-yellow-100 text-yellow-800' },
            { id: 'presentationscheduled', name: 'Presentation Scheduled', color: 'bg-orange-100 text-orange-800' },
            { id: 'decisionmakerboughtin', name: 'Decision Maker Bought-In', color: 'bg-purple-100 text-purple-800' },
            { id: 'contractsent', name: 'Contract Sent', color: 'bg-indigo-100 text-indigo-800' },
            { id: 'closedwon', name: 'Closed Won', color: 'bg-green-100 text-green-800' },
            { id: 'closedlost', name: 'Closed Lost', color: 'bg-red-100 text-red-800' }
        ];

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-CA', {
                style: 'currency',
                currency: 'CAD'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-CA', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function getStageInfo(stageId) {
            return dealStages.find(stage => stage.id === stageId) || dealStages[0];
        }

        function getNextStage(currentStage) {
            const currentIndex = dealStages.findIndex(stage => stage.id === currentStage);
            if (currentIndex < dealStages.length - 2) {
                return dealStages[currentIndex + 1];
            }
            return null;
        }

        // API functions
        async function fetchDeals() {
            const apiKey = document.getElementById('apiKey').value;
            const backendUrl = document.getElementById('backendUrl').value;

            if (!apiKey || !backendUrl) {
                alert('Please fill in both Backend URL and HubSpot Access Token');
                deals = [...demoDeals];
                renderDeals();
                return;
            }

            setLoading(true);
            
            try {
                const response = await fetch(`${backendUrl}/api/deals`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    deals = data.results || [];
                    isConfigured = true;
                    document.getElementById('config').style.display = 'none';
                    alert(`Success! Loaded ${deals.length} deals from HubSpot`);
                } else {
                    const errorData = await response.json();
                    alert(`Backend Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
                    deals = [...demoDeals];
                }
            } catch (error) {
                alert(`Connection Error: ${error.message}`);
                deals = [...demoDeals];
            }
            
            setLoading(false);
            renderDeals();
            updateStats();
        }

        async function updateDealStage(dealId, newStage) {
            const apiKey = document.getElementById('apiKey').value;
            const backendUrl = document.getElementById('backendUrl').value;

            if (!apiKey || !backendUrl) {
                // Demo mode
                deals = deals.map(deal => 
                    deal.id === dealId ? { ...deal, dealstage: newStage } : deal
                );
                renderDeals();
                return;
            }

            try {
                const response = await fetch(`${backendUrl}/api/deals`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dealId, dealstage: newStage })
                });

                if (response.ok) {
                    deals = deals.map(deal => 
                        deal.id === dealId ? { ...deal, dealstage: newStage } : deal
                    );
                    renderDeals();
                } else {
                    const errorData = await response.json();
                    alert(`Error updating deal: ${errorData.error}`);
                }
            } catch (error) {
                alert(`Error updating deal: ${error.message}`);
            }
        }

        // UI functions
        function setLoading(isLoading) {
            loading = isLoading;
            const refreshIcon = document.getElementById('refreshIcon');
            const connectBtn = document.getElementById('connectBtn');
            
            if (isLoading) {
                refreshIcon.classList.add('spinner');
                connectBtn.textContent = 'Testing...';
                connectBtn.disabled = true;
            } else {
                refreshIcon.classList.remove('spinner');
                connectBtn.textContent = 'Connect';
                connectBtn.disabled = false;
            }
        }

        function renderDeals() {
            const dealsList = document.getElementById('dealsList');
            dealsList.innerHTML = '';

            deals.forEach(deal => {
                const stageInfo = getStageInfo(deal.dealstage);
                const nextStage = getNextStage(deal.dealstage);
                
                const dealElement = document.createElement('div');
                dealElement.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6';
                
                dealElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <h3 class="text-lg font-semibold text-gray-900">${deal.dealname}</h3>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${stageInfo.color}">
                                    ${stageInfo.name}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <span>ðŸ’°</span>
                                    <span class="font-medium">${formatCurrency(deal.amount || 0)}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>ðŸ“…</span>
                                    <span>${deal.closedate ? formatDate(deal.closedate) : 'No date set'}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>ðŸ‘¤</span>
                                    <span>${deal.contact || 'No contact'}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-600">
                                        ${deal.companies?.[0]?.name || deal.company || 'No company'}
                                    </span>
                                </div>
                            </div>

                            ${(deal.email || deal.phone) ? `
                                <div class="flex gap-4 mt-3 text-sm">
                                    ${deal.email ? `<a href="mailto:${deal.email}" class="text-blue-600 hover:text-blue-700">ðŸ“§ ${deal.email}</a>` : ''}
                                    ${deal.phone ? `<a href="tel:${deal.phone}" class="text-blue-600 hover:text-blue-700">ðŸ“ž ${deal.phone}</a>` : ''}
                                </div>
                            ` : ''}
                        </div>

                        ${nextStage && !['closedwon', 'closedlost'].includes(deal.dealstage) ? `
                            <button onclick="updateDealStage('${deal.id}', '${nextStage.id}')" 
                                    class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 ml-4">
                                <span class="text-sm">Advance to ${nextStage.name}</span>
                                <span>â†’</span>
                            </button>
                        ` : ''}
                    </div>
                `;
                
                dealsList.appendChild(dealElement);
            });
        }

        function updateStats() {
            const totalValue = deals.reduce((sum, deal) => sum + (deal.amount || 0), 0);
            const activeCount = deals.filter(deal => !['closedwon', 'closedlost'].includes(deal.dealstage)).length;
            
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('activeCount').textContent = activeCount;
        }

        function addDeal() {
            const name = document.getElementById('newDealName').value;
            const amount = document.getElementById('newDealAmount').value;
            const date = document.getElementById('newDealDate').value;

            if (!name || !amount) {
                alert('Please fill in Deal Name and Amount');
                return;
            }

            const newDeal = {
                id: (deals.length + 1).toString(),
                dealname: name,
                amount: parseFloat(amount),
                dealstage: 'appointmentscheduled',
                closedate: date,
                contact: 'New Contact',
                companies: [{ name: 'New Company' }]
            };

            deals.push(newDeal);
            renderDeals();
            updateStats();
            closeModal();
        }

        function openModal() {
            document.getElementById('addDealModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('addDealModal').classList.add('hidden');
            document.getElementById('newDealName').value = '';
            document.getElementById('newDealAmount').value = '';
            document.getElementById('newDealDate').value = '';
        }

        // Event listeners
        document.getElementById('connectBtn').addEventListener('click', fetchDeals);
        document.getElementById('refreshBtn').addEventListener('click', fetchDeals);
        document.getElementById('addDealBtn').addEventListener('click', openModal);
        document.getElementById('cancelDealBtn').addEventListener('click', closeModal);
        document.getElementById('saveDealBtn').addEventListener('click', addDeal);

        // Close modal on outside click
        document.getElementById('addDealModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Initialize
        deals = [...demoDeals];
        renderDeals();
        updateStats();
    </script>
</body>
</html>
